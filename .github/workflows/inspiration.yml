name: ü™Ñ Actualizar frase inspiradora y clima

on:
  schedule:
    - cron: "0 */12 * * *" # Cada 12 horas
  workflow_dispatch: # Permite ejecutarlo manualmente

permissions:
  contents: write

jobs:
  update-activity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias necesarias
        run: sudo apt-get install -y jq curl

      - name: Generar clima y frase con OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CITY: "Medell√≠n"
          COUNTRY: "CO"
          MAX_TOKENS: "300"
          MODEL: "gpt-4o-mini"
        run: |
          set -euo pipefail

          # 1Ô∏è‚É£ Obtener clima (wttr.in no necesita API key)
          WEATHER_RAW=$(curl -s "https://wttr.in/${CITY}?format=%l+:+%C+%t+%w")
          WEATHER_LINE=$(echo "${WEATHER_RAW}" | tr -d '\r\n')

          # 2Ô∏è‚É£ Crear prompt para OpenAI
          PROMPT="Eres un asistente conciso y motivador. Genera una frase inspiradora (1-2 oraciones) enfocada en programaci√≥n, disciplina y mejora continua. Luego agrega una sugerencia corta (1 l√≠nea) de acci√≥n pr√°ctica para el d√≠a relacionada con programaci√≥n (ej: 'Lee 10 l√≠neas de c√≥digo open-source', 'Resuelve un kata sencillo'). Formato de salida: {\"quote\": \"<frase>\", \"action\": \"<acci√≥n>\"}"

          # 3Ô∏è‚É£ Llamar a la API de OpenAI (sin bloque multil√≠nea)
          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -d "$(jq -n \
              --arg model "$MODEL" \
              --arg prompt "$PROMPT" \
              --arg max_tokens "$MAX_TOKENS" \
              '{model: $model, messages: [{role: "user", content: $prompt}], max_tokens: ($max_tokens | tonumber), temperature: 0.8, n: 1}')")

          CHOICE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$CHOICE" ]; then
            echo "‚ö†Ô∏è Error: OpenAI no devolvi√≥ texto v√°lido"
            echo "$RESPONSE"
            exit 1
          fi

          # 4Ô∏è‚É£ Crear archivo activity.md
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          {
            echo "## üå§Ô∏è Clima y frase inspiradora"
            echo ""
            echo "**√öltima actualizaci√≥n:** ${DATE}"
            echo ""
            echo "**Ciudad:** ${WEATHER_LINE}"
            echo ""
            echo "üß† **Inspiraci√≥n del d√≠a:**"
            echo "\`\`\`"
            echo "$CHOICE"
            echo "\`\`\`"
          } > activity.md

      - name: Subir cambios al repositorio
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add activity.md
          git commit -m "‚ú® Actualizaci√≥n autom√°tica de clima y frase inspiradora"
          git push
