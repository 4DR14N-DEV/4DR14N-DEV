name: ü™Ñ Actualizar frase inspiradora

on:
  schedule:
    - cron: "0 */12 * * *" # Cada 12 horas
  workflow_dispatch: # Permite ejecutarlo manualmente

permissions:
  contents: write

jobs:
  update-activity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias necesarias
        run: sudo apt-get install -y jq curl

      - name: Generar frase inspiradora con OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MAX_TOKENS: "300"
          MODEL: "gpt-4o-mini"
        run: |
          set -euo pipefail

          # 1Ô∏è‚É£ Crear prompt para OpenAI
          PROMPT="Eres un asistente conciso y motivador. Genera una frase inspiradora (1-2 oraciones) enfocada en programaci√≥n, disciplina y mejora continua. Luego agrega una sugerencia corta (1 l√≠nea) de acci√≥n pr√°ctica para el d√≠a relacionada con programaci√≥n. Formato de salida: {\"quote\": \"<frase>\", \"action\": \"<acci√≥n>\"}"

          # 2Ô∏è‚É£ Llamar a la API de OpenAI
          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -d "$(jq -n \
              --arg model "$MODEL" \
              --arg prompt "$PROMPT" \
              --arg max_tokens "$MAX_TOKENS" \
              '{model: $model, messages: [{role: "user", content: $prompt}], max_tokens: ($max_tokens | tonumber), temperature: 0.8, n: 1}')")

          CHOICE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$CHOICE" ]; then
            echo "‚ö†Ô∏è Error: OpenAI no devolvi√≥ texto v√°lido"
            echo "$RESPONSE"
            exit 1
          fi

          # 3Ô∏è‚É£ Procesar datos para insertar en README
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          QUOTE=$(echo "$CHOICE" | jq -r '.quote // empty' 2>/dev/null || echo "$CHOICE")
          ACTION_LINE=$(echo "$CHOICE" | jq -r '.action // empty' 2>/dev/null || echo "")

          # Escapar caracteres especiales para HTML/Markdown
          QUOTE_ESCAPED=$(echo "$QUOTE" | sed 's/"/\\"/g; s/[\/&]/\\&/g')
          ACTION_ESCAPED=$(echo "$ACTION_LINE" | sed 's/"/\\"/g; s/[\/&]/\\&/g')

          NEW_CONTENT="<!--START_SECTION:inspiracion-->\n<div align=\"center\">\n\n :robot:üí° **Inspiraci√≥n Autom√°tica**  \n\nüìÖ **Fecha de actualizaci√≥n:** ${DATE}  \n\nüéØ **Frase del d√≠a:**  \n> ${QUOTE_ESCAPED}\n\nüöÄ **Acci√≥n recomendada:**  \n> ${ACTION_ESCAPED}\n\n<p align=\"center\">\n  <sub>Actualizado autom√°ticamente cada 12 horas por ü™Ñ GitHub Actions</sub>\n</p>\n\n</div>\n<!--END_SECTION:inspiracion-->"

          # 4Ô∏è‚É£ Reemplazar bloque en README.md (sin duplicar)
          sed -i '/<!--START_SECTION:inspiracion-->/,/<!--END_SECTION:inspiracion-->/c\'"$NEW_CONTENT" README.md

          echo "‚úÖ README actualizado correctamente con la nueva inspiraci√≥n."
