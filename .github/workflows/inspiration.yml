name: üí° Inspiraci√≥n Diaria

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  inspiracion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - run: sudo apt-get install -y jq curl

      - run: |
          set -euo pipefail

          PROMPT="Genera una frase inspiradora (1-2 oraciones) sobre programaci√≥n y mejora continua. Luego, una sugerencia pr√°ctica (1 l√≠nea) para el d√≠a. Formato: {\"quote\": \"frase\", \"action\": \"acci√≥n\"}"

          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "{\"model\": \"gpt-4o-mini\", \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}], \"max_tokens\": 300, \"temperature\": 0.8}")

          CHOICE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$CHOICE" ]; then
            echo "Error: OpenAI no devolvi√≥ contenido v√°lido"
            exit 1
          fi

          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          QUOTE=$(echo "$CHOICE" | jq -r '.quote // empty' 2>/dev/null || echo "$CHOICE")
          ACTION=$(echo "$CHOICE" | jq -r '.action // empty' 2>/dev/null || echo "")

          QUOTE_ESCAPED=$(echo "$QUOTE" | sed 's/[\/&]/\\&/g')
          ACTION_ESCAPED=$(echo "$ACTION" | sed 's/[\/&]/\\&/g')

          NEW_CONTENT="## üí° Inspiraci√≥n ‚Äî ${DATE}\n\nüí¨ **Frase:**\n> ${QUOTE_ESCAPED}\n\nüõ†Ô∏è **Acci√≥n:** ${ACTION_ESCAPED}\n\n_Automatizado._"

          awk -v new_content="$NEW_CONTENT" '
            /<!--START_SECTION:inspiracion-->/ {print; print new_content; f=1; next}
            /<!--END_SECTION:inspiracion-->/ {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

          echo "Inspiraci√≥n actualizada."

      - run: |
          git config user.name "Inspiration Bot"
          git config user.email "bot@4drian.dev"
          git add README.md
          git diff --staged --quiet || git commit -m "üí° Actualizar inspiraci√≥n" && git push


